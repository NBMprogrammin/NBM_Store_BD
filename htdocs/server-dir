name: Deploy Laravel to InfinityFree

on:
    workflow_dispatch:
    push:
        branches:
            - main

jobs:
    deploy:
        name: ğŸš€ Build and Deploy
        runs-on: ubuntu-latest

        steps:
            # Ø§Ù„Ø®Ø·ÙˆØ© 1: Clone Ø§Ù„ÙƒÙˆØ¯
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4
              with:
                  # Ù‡Ø°Ø§ Ù…Ù‡Ù…: ØªØ¬Ø§Ù‡Ù„ Ø­Ø§Ù„Ø© Ù…Ù„ÙØ§Øª composer Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                  fetch-depth: 0

            # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¹Ø¯Ø§Ø¯ PHP 8.2
            - name: âš™ï¸ Setup PHP 8.2
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.2"
                  extensions: mbstring, xml, ctype, iconv, intl, pdo, mysql, bcmath, openssl, tokenizer, gd
                  tools: composer:v2

            # Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Laravel 11
            - name: ğŸ”§ Ensure Laravel 11 Compatibility
              run: |
                  # 1. ØªØ£ÙƒØ¯ Ø£Ù†Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Laravel 11 (Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ PHP 8.2)
                  if grep -q '"laravel/framework": "^12.0"' composer.json; then
                    echo "ğŸ”„ Downgrading from Laravel 12 to Laravel 11 for PHP 8.2 compatibility..."
                    sed -i 's/"laravel/framework": "^12.0"/"laravel/framework": "^11.0"/' composer.json
                    sed -i 's/"laravel/sanctum": "^4.2"/"laravel/sanctum": "^3.5"/' composer.json
                  fi

                  # 2. ØªØ£ÙƒØ¯ Ù…Ù† PHP 8.2
                  sed -i 's/"php": "^8.3"/"php": "^8.2"/' composer.json 2>/dev/null || true

                  # 3. Ø£Ø¶Ù platform config Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
                  if ! grep -q '"platform"' composer.json; then
                    sed -i '/"config": {/a\        "platform": {"php": "8.2"},' composer.json
                  fi

            # Ø§Ù„Ø®Ø·ÙˆØ© 4: ğŸ“¦ ØªØ«Ø¨ÙŠØª/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø²Ù… (Ø§Ù„Ø­Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)
            - name: ğŸ“¦ Force Update Dependencies
              run: |
                  echo "ğŸ§¹ Removing old lock file..."
                  rm -f composer.lock

                  echo "ğŸ—‘ï¸ Clearing composer cache..."
                  composer clear-cache

                  echo "ğŸ”„ Running composer update to create new lock file..."
                  composer update --no-interaction --prefer-dist --no-scripts --optimize-autoloader --with-all-dependencies

                  echo "âœ… Dependencies updated successfully!"

            # Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø¥Ø¹Ø¯Ø§Ø¯ Laravel
            - name: ğŸ› ï¸ Setup Laravel Environment
              run: |
                  echo "ğŸ”‘ Generating application key..."
                  if [ ! -f ".env" ]; then
                    cp .env.example .env
                  fi

                  # Ø§Ø³ØªØ®Ø¯Ù… artisan key:generate ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…ÙØªØ§Ø­ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                  if ! grep -q "^APP_KEY=base64:" .env 2>/dev/null; then
                    php artisan key:generate
                  fi

                  echo "ğŸ—ƒï¸ Clearing cache..."
                  php artisan config:clear
                  php artisan cache:clear

                  echo "ğŸ“ Setting up directories..."
                  mkdir -p storage/framework/{sessions,views,cache}
                  chmod -R 775 storage bootstrap/cache

                  echo "ğŸ”— Creating storage link..."
                  php artisan storage:link 2>/dev/null || true

            # Ø§Ù„Ø®Ø·ÙˆØ© 6: Ø¨Ù†Ø§Ø¡ Assets (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            - name: ğŸ¨ Build Frontend Assets
              run: |
                  if [ -f "package.json" ]; then
                    echo "ğŸ“¦ Installing npm dependencies..."
                    npm ci --silent --no-audit --prefer-offline
                    
                    echo "ğŸ—ï¸ Building assets..."
                    npm run build --silent
                  else
                    echo "â„¹ï¸ No package.json found, skipping npm build"
                  fi

            # Ø§Ù„Ø®Ø·ÙˆØ© 7: â˜ï¸ Ø§Ù„Ø±ÙØ¹ Ø¹Ø¨Ø± FTP
            - name: â˜ï¸ Deploy to InfinityFree
              uses: SamKirkland/FTP-Deploy-Action@v4.3.5
              with:
                  server: ${{ secrets.FTP_SERVER }}
                  username: ${{ secrets.FTP_USERNAME }}
                  password: ${{ secrets.FTP_PASSWORD }}
                  server-dir: ./htdocs/
                  local-dir: ./
                  exclude: |
                      **/.git*
                      **/.github*
                      **/node_modules/*
                      **/tests/*
                      **/vendor/*
                      .env
                      .env.example
                      composer.json
                      composer.lock
                      package.json
                      package-lock.json
                      README.md
                      storage/*
                      !storage/framework/
                      !storage/framework/sessions/
                      !storage/framework/views/
                      !storage/framework/cache/
                      *.sqlite
                      *.log
                      phpunit.xml
                      deploy.yaml
                      .gitignore
                      .gitattributes
                  dangerous-clean-slate: false
                  timeout: 180000

            # Ø§Ù„Ø®Ø·ÙˆØ© 8: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø´Ø±
            - name: âœ… Verify Deployment
              run: |
                  echo "ğŸ‰ Deployment completed successfully!"
                  echo "âœ… Laravel 11 installed with PHP 8.2"
                  echo "âœ… Dependencies resolved and locked"
                  echo "âœ… Files uploaded to InfinityFree"
