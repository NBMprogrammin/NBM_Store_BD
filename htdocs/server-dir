name: Deploy Laravel to InfinityFree

on:
    workflow_dispatch:
    push:
        branches:
            - main

jobs:
    deploy:
        name: ğŸš€ Build and Deploy
        runs-on: ubuntu-latest

        steps:
            # Ø§Ù„Ø®Ø·ÙˆØ© 1: Clone Ø§Ù„ÙƒÙˆØ¯
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¹Ø¯Ø§Ø¯ PHP
            - name: âš™ï¸ Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.2" # InfinityFree ÙŠØ¯Ø¹Ù… Ø­ØªÙ‰ 8.2
                  extensions: mbstring, xml, ctype, iconv, intl, pdo, mysql, bcmath, openssl, tokenizer
                  tools: composer:v2

            # Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥ØµÙ„Ø§Ø­ composer.json Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ PHP 8.2
            - name: ğŸ”§ Fix Dependencies Compatibility
              run: |
                  # ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Laravel Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ PHP 8.2
                  if grep -q '"laravel/framework": "^12.0"' composer.json; then
                    echo "âš ï¸ Laravel 12 requires PHP 8.3+, downgrading to Laravel 11..."
                    sed -i 's/"laravel/framework": "^12.0"/"laravel/framework": "^11.0"/' composer.json
                    sed -i 's/"laravel/sanctum": "^4.2"/"laravel/sanctum": "^3.5"/' composer.json
                  fi

                  # ØªØ£ÙƒØ¯ Ù…Ù† PHP 8.2
                  sed -i 's/"php": "^8.3"/"php": "^8.2"/' composer.json || true
                  sed -i 's/"php": "^8.2.0"/"php": "^8.2"/' composer.json || true

            # Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªØ«Ø¨ÙŠØª dependencies
            - name: ğŸ“¦ Install Composer Dependencies
              run: |
                  rm -f composer.lock
                  composer install --no-interaction --prefer-dist --optimize-autoloader --no-scripts
                  # Ø¥Ø°Ø§ ÙØ´Ù„ØŒ Ø¬Ø±Ø¨ update
                  composer update --no-interaction --prefer-dist --optimize-autoloader --no-scripts || true

            # Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø¥Ø¹Ø¯Ø§Ø¯ Laravel
            - name: ğŸ› ï¸ Setup Laravel
              run: |
                  cp .env.example .env
                  php artisan key:generate
                  php artisan config:clear
                  php artisan cache:clear

                  # ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª
                  mkdir -p storage/framework/{sessions,views,cache}
                  chmod -R 775 storage bootstrap/cache

            # Ø§Ù„Ø®Ø·ÙˆØ© 6: Ø¨Ù†Ø§Ø¡ Assets (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ npm)
            - name: ğŸ¨ Build Assets (Optional)
              run: |
                  if [ -f "package.json" ]; then
                    npm ci --no-audit --prefer-offline
                    npm run build
                  else
                    echo "No package.json found, skipping npm build"
                  fi

            # Ø§Ù„Ø®Ø·ÙˆØ© 7: Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¹Ø¨Ø± FTP
            - name: â˜ï¸ Deploy via FTP
              uses: SamKirkland/FTP-Deploy-Action@v4.3.5
              with:
                  server: ${{ secrets.FTP_SERVER }} # Ù…Ø«Ù„: ftpupload.net
                  username: ${{ secrets.FTP_USERNAME }} # Ù…Ø«Ù„: if0_40642021
                  password: ${{ secrets.FTP_PASSWORD }} # âš ï¸ Ø§Ø³ØªØ®Ø¯Ù… Secrets!
                  server-dir: ./htdocs/ # âš ï¸ Ù‡Ø°Ø§ Ù…Ù‡Ù… Ù„Ù€ InfinityFree
                  local-dir: ./
                  exclude: |
                      **/.git*
                      **/.github*
                      **/node_modules/*
                      **/tests/*
                      **/vendor/*
                      .env
                      .env.example
                      composer.json
                      composer.lock
                      package.json
                      package-lock.json
                      README.md
                      storage/*
                      !storage/framework/
                      !storage/framework/sessions/
                      !storage/framework/views/
                      !storage/framework/cache/
                      *.sqlite
                      *.log
                      phpunit.xml
                  dangerous-clean-slate: false
                  timeout: 120000
